{% extends 'base/main.html' %}
{% load static %}

{% block content %}
{% include 'base/roaster_profile_navbar.html' %}


<div class="container-fluid p-5">

    <div class="row justify-content-center g-2">
        <div class="col-3">
            <h3>
                Search by:
            </h3>
        </div>
        <div class="col-9">
            
            <div class="container d-flex border rounded p-3 pt-4 mb-3" style="flex-direction: column;">
                <div class="container d-flex" style="flex-direction: row;">
                    <img class="rounded-circle" width="75px" height="75px" src="{% static 'img/charlesdeluvio-K4mSJ7kc0As-unsplash.jpg' %}" alt="">
                    <div class="col ms-2 container d-flex" style="flex-direction: column;">
                        <h4 class="mb-0"> Farmer name </h4>
                        <p class="mb-2">Farm Name, Farm Location</p>
                        <p class="mb-0">The story text will go here, however not all of it will be displayed. Perhaps the first three or four sentences, 
                            then, the user can click to expand the story if interested, and be prompted to view their full profile, where 
                            they can then request a meeting and...</p>
                    </div>
                </div>
                <hr>
                <div class="container d-flex" style="flex-direction: row;">
                    <div class="col-auto pe-5">
                        <p class="mb-1" style="font-weight: 500;">Cultivars:</p>
                        <p class="mb-1"> Arabica </p>
                    </div>
                    <div class="col-auto px-2">
                        <p class="mb-1" style="font-weight: 500;">Annual Yield:</p>
                        <p class="mb-1" style="font-weight: 500;"> Cup Scores:</p>
                        <p class="mb-1" style="font-weight: 500;">Processing:</p>
                    </div>
                    <div class="col-auto px-2 text-end">
                        <p class="mb-1">12,000 lbs</p>
                        <p class="mb-1">95 - 98</p>
                        <p class="mb-1">Washed</p>

                    </div>
                    <div class="col d-flex justify-content-end">
                        {% if can_request_meetings %}
                        <a href="#" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#requestMeetingModal" data-user-id="{{ farmer.user.id }}">Connect</a>
                        {% else %}
                        <p class="text-warning">You have reached the maximum number of meeting requests.</p>
                        {% endif %}
                        <a href="#" class="btn btn-primary mt-3">View Profile</a>


                    </div>
                </div>
            </div>


            <div class="container d-flex border rounded" style="flex-direction: row;">
                <img class="rounded-circle" width="75px" height="75px" src="{% static 'img/charlesdeluvio-K4mSJ7kc0As-unsplash.jpg' %}" alt="">
                <div class="col container d-flex" style="flex-direction: column;">
                    <h4> Farmer name </h4>
                    <p>The story text will go here, however not all of it will be displayed. Perhaps the first three or four sentences, 
                        then, the user can click to expand the story if interested, and be prompted to view their full profile, where 
                        they can then request a meeting and...</p>
                </div>
            </div>

            
        </div>
    </div>

    


</div>


<div class="container-fluid profile-bg">
    <h2>Connections</h2>
    <!-- Main Content Wrapper -->
    <div class="d-flex col" style="max-width: 1500px; margin: 0 auto;">

    <!-- Placeholder Container on the Left -->
        <div style="width: 20%; background-color: #f8f9fa; padding: 20px; margin-right: 20px;">
            <h4>Placeholder</h4>
            <p>This area can be used for additional content or filters.asdasdasdasdasdasd asdasdasdasdas</p>
        </div>

    <!-- Farmer Cards and Connection Manager -->
        <div class="d-flex justify-content-end" style="max-width: 1200px; margin-left: auto;">
            <!-- Farmer Cards Section -->
            <div class="d-flex flex-wrap" style="width: 65%; justify-content: center;">
                {% for farmer in farmers %}

                <div class="container d-flex border rounded p-3 pt-4 mb-3" style="flex-direction: column;">
                    <div class="container d-flex" style="flex-direction: row;">
                        <img class="rounded-circle" width="75px" height="75px" src="{% if farmer.profile_picture %}{{ farmer.profile_picture.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}" alt="">
                        <div class="col ms-2 container d-flex" style="flex-direction: column;">
                            <h4> {{ farmer.user.username }} </h4>
                            <p>The story text will go here, however not all of it will be displayed. Perhaps the first three or four sentences, 
                                then, the user can click to expand the story if interested, and be prompted to view their full profile, where 
                                they can then request a meeting and...</p>
                        </div>
                    </div>
                    <hr>
                    <div class="container d-flex" style="flex-direction: row;">
                        <div class="col">
                            Cultivars
                            <p> {{ farmer.cultivars }} </p>
                        </div>
                        <div class="col">
                            Annual Yield:
                            
                        </div>
                        <div class="col">
                            100 {{ farmers.annual_production }}

                        </div>
                    </div>
                </div>



                <!--
                    <div class="card shadow-sm" style="width: 18rem; margin: 10px;">
                        <img src="{% if farmer.profile_picture %}{{ farmer.profile_picture.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}" class="card-img-top" alt="Farmer Image">
                        <div class="card-body" style="background-color: #4e555b; color: white;">
                            <h5 class="card-title">{{ farmer.user.username }}</h5>
                            <p class="card-text">
                                <strong>Origin:</strong> {{ farmer.country }}<br>
                                <strong>Type:</strong> {{ farmer.cup_scores_received }}<br>
                                <strong>Quantity:</strong> {{ farmer.annual_production }} lbs
                            </p>
                            {% if can_request_meetings %}
                                <a href="#" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#requestMeetingModal" data-user-id="{{ farmer.user.id }}">Connect</a>
                            {% else %}
                                <p class="text-warning">You have reached the maximum number of meeting requests.</p>
                            {% endif %}
                            <a href="{% url 'farmer_profile' farmer.user.id %}" class="btn btn-primary mt-3">View Profile</a>

                        </div>
                    </div>
                -->

                {% empty %}
                    <p>No farmers available at the moment.</p>
                {% endfor %}
            </div>


            

            <!-- Connection Manager Section -->
            <div style="width: 40%; align-right: flex-start;">
                <div class="card shadow-sm" style="background-color: white;">
                    <div class="card-header">
                        <h5 class="card-title">Connection Manager</h5>
                    </div>
                    <div class="card-body">
                        {% for meeting in meeting_requests %}
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded
                                {% if meeting.status == 'accepted' %} bg-success
                                {% elif meeting.status == 'pending' %} bg-primary
                                {% elif meeting.status == 'rejected' %} bg-danger
                                {% endif %}">
                                <div>
                                    <strong>{{ meeting.requestee.username }}</strong>
                                    <div>{{ meeting.proposed_date|date:"n/j/Y" }}</div>

                                    <div>{{ meeting.proposed_date|time:"g:iA" }} est.</div>
                                </div>
                                <div class="d-flex">
                                    {% if meeting.status == 'pending' %}
                                        <form method="post" action="{% url 'connections' %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="meeting_id" value="{{ meeting.id }}">
                                            <button type="submit" name="retrieve_meeting_request" class="btn btn-sm btn-warning">Retrieve</button>
                                        </form>
                                    {% elif meeting.status == 'rejected' %}
                                        <form method="post" action="{% url 'connections' %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="meeting_id" value="{{ meeting.id }}">
                                            <button type="submit" name="delete_meeting_request" class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        {% empty %}
                            <p>No meeting requests available.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End of Main Content Wrapper -->
</div>

<style>
    .container-fluid.profile-bg {
        padding: 20px;
    }
    .d-flex.justify-content-between {
        margin: 0 auto;
    }
    .card {
        margin: 10px;
    }
</style>

<!-- Request Meeting Modal -->
<div class="modal fade" id="requestMeetingModal" tabindex="-1" aria-labelledby="requestMeetingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestMeetingModalLabel">Request Meeting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="meetingRequestForm">
                {% csrf_token %}
                <input type="hidden" name="user_id" id="user_id_input">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="proposed_date" class="form-label">Select Date and Time</label>
                        {{ form.proposed_date.errors }}
                        {{ form.proposed_date }}
                    </div>
                    <div class="mb-3">
                        <label for="message" class="form-label">Message/Notes</label>
                        {{ form.message.errors }}
                        {{ form.message }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Send Request</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Show modal if `show_modal` is True
    {% if show_modal %}
    var myModal = new bootstrap.Modal(document.getElementById('requestMeetingModal'), {
        keyboard: false
    });
    myModal.show();
    {% endif %}

    // Capture the user ID when clicking the Connect button
    document.querySelectorAll('[data-bs-target="#requestMeetingModal"]').forEach(button => {
        button.addEventListener('click', function() {
            var userId = this.getAttribute('data-user-id');
            document.getElementById('user_id_input').value = userId;
        });
    });
</script>

{% endblock %}
